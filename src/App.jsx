import { useState, useEffect, useCallback } from "react";

const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON = "YOUR_SUPABASE_ANON_KEY";
const ADMIN_PW = "linder2026";
const REVEAL = "Matches revealed soon";

const LOGO_FULL = "/logo.png";
const LOGO_SM = "/logo.png";
const LOGO_MD = "/logo.png";

// DATA LAYER
const useSB = SUPABASE_URL !== "YOUR_SUPABASE_URL";
const sbF = async (t, m, b, f) => { let u = `${SUPABASE_URL}/rest/v1/${t}`; const h = { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}`, "Content-Type": "application/json", Prefer: "return=representation" }; if (m === "GET") u += f ? `?${f}` : "?select=*"; if ((m === "PATCH" || m === "DELETE") && f) u += `?${f}`; const r = await fetch(u, { method: m, headers: h, ...(b ? { body: JSON.stringify(b) } : {}) }); if (!r.ok) throw new Error(await r.text()); const tx = await r.text(); return tx ? JSON.parse(tx) : null; };
const FK = { P: "lndr11p", M: "lndr11m", S: "lndr11s" };
const wG = async k => { try { const r = localStorage.getItem(k); return r ? JSON.parse(r) : null; } catch { return null; } };
const wS = async (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
const db = {
  async profiles() { return useSB ? sbF("profiles", "GET", null, "select=*&order=created_at.asc") : (await wG(FK.P)) || []; },
  async addProfile(n, a) { if (useSB) { const r = await sbF("profiles", "POST", { name: n, answers: a }); return r[0]; } const p = { id: `u${Date.now()}${Math.random().toString(36).substr(2, 5)}`, name: n, answers: a }; const all = (await wG(FK.P)) || []; all.push(p); await wS(FK.P, all); return p; },
  async matches() { return useSB ? sbF("matches", "GET", null, "select=*&order=created_at.asc") : (await wG(FK.M)) || []; },
  async addMatch(u1, u2, sc) { if (useSB) { const r = await sbF("matches", "POST", { user1: u1, user2: u2, score: sc, status1: "pending", status2: "pending" }); return r[0]; } const m = { id: `m${Date.now()}`, user1: u1, user2: u2, score: sc, status1: "pending", status2: "pending" }; const all = (await wG(FK.M)) || []; all.push(m); await wS(FK.M, all); return m; },
  async updMatch(id, d) { if (useSB) return sbF("matches", "PATCH", d, `id=eq.${id}`); const all = (await wG(FK.M)) || []; const i = all.findIndex(m => m.id === id); if (i >= 0) { Object.assign(all[i], d); await wS(FK.M, all); } },
  async clear() { if (useSB) { await sbF("matches", "DELETE", null, "id=neq.00000000-0000-0000-0000-000000000000"); await sbF("profiles", "DELETE", null, "id=neq.00000000-0000-0000-0000-000000000000"); } else { await wS(FK.P, []); await wS(FK.M, []); } },
};
const getSess = () => { try { return JSON.parse(localStorage.getItem(FK.S)); } catch { return null; } };
const putSess = s => localStorage.setItem(FK.S, JSON.stringify(s));
const delSess = () => localStorage.removeItem(FK.S);

// QUESTIONS
const QS = [
  {id:"gender",type:"pill",q:"I identify as",opts:["Male","Female","Non-binary"],sec:0},
  {id:"sexuality",type:"pill",q:"I'm interested in",opts:["Men","Women","Both","Not sure yet"],sec:0},
  {id:"age",type:"age_text",q:"How old are you?",sec:0},
  {id:"loud",type:"agree",q:"I'm usually the loudest person in the room.",sec:1},
  {id:"recharge",type:"card",q:"After a long week, you recharge by...",opts:["Going out with people","A mix \u2014 depends on the week","Quiet time, maybe one friend","Completely alone"],sec:1},
  {id:"attach",type:"card",q:"How quickly do you catch feelings?",opts:["Embarrassingly fast","Pretty quickly if the vibe is right","I take my time","Very slowly \u2014 I need to really know someone"],sec:2},
  {id:"secure",type:"agree",q:"When someone I'm seeing doesn't text back for a while, it doesn't bother me.",sec:2},
  {id:"conflict",type:"card",q:"When there's tension with someone you care about...",opts:["Talk it through directly","Get passionate and hash it out","Need space to process first","Deflect with humour"],sec:2},
  {id:"decide",type:"agree",q:"I go with my gut over logic when making big decisions.",sec:3},
  {id:"freeyear",type:"card",q:"A free year, no obligations \u2014 you'd...",opts:["Travel everywhere","Build something","Deepen your relationships","Focus on yourself"],sec:3},
  {id:"humour",type:"card",q:"What makes you laugh the hardest?",opts:["Dry wit and sarcasm","Absurd, unhinged humour","Roasting and banter","Wholesome, feel-good stuff"],sec:3},
  {id:"love_give",type:"card",q:"How do you show someone you're into them?",opts:["Words \u2014 compliments, texts, telling them","Touch \u2014 physical closeness, affection","Time \u2014 giving them my full attention","Effort \u2014 thoughtful gestures, planning, helping"],sec:4},
  {id:"love_need",type:"card",q:"What makes you feel most cared for?",opts:["Hearing how they feel about me","Physical affection","Someone giving me their undivided time","Someone going out of their way for me"],sec:4},
  {id:"pref_energy",type:"card",q:"You're drawn to someone who is...",opts:["Outgoing and social","Calm and thoughtful","Ambitious and driven","Relaxed and easy-going"],sec:5},
  {id:"pref_quality",type:"card",q:"Most attractive quality?",opts:["Sense of humour","Emotional intelligence","Ambition","Warmth and kindness"],sec:5},
  {id:"first_date",type:"card",q:"Ideal first date?",opts:["Coffee and a walk","Drinks at a bar","Something adventurous","Dinner somewhere nice","Cooking together at home"],sec:5},
  {id:"pref_age",type:"age_range_text",q:"Age range you're open to?",sec:5},
  {id:"hobbies",type:"bubble",q:"What are you into?",opts:["Sports","Music","Gaming","Reading","Cooking","Travel","Art & design","Going out","Film & TV","Photography"],max:4,sec:6},
  {id:"saturday",type:"card",q:"Ideal Saturday night?",opts:["Out with a group","Cosy night in","Something spontaneous","Working on something"],sec:6},
  {id:"green_flag",type:"text",q:"Your biggest green flag?",ph:"What makes you a great partner...",sec:6},
  {id:"fact",type:"text",q:"A random fact about you",ph:"Something unexpected or interesting...",sec:6},
  {id:"go_out",type:"card",q:"How often do you go out or party?",opts:["Every weekend","Pretty often","Sometimes","Rarely"],sec:7},
  {id:"drink",type:"pill",q:"Do you drink?",opts:["Socially","Sometimes","Rarely","No"],sec:7},
  {id:"smoke",type:"pill",q:"Do you smoke?",opts:["Yes","Socially","No","Prefer not to say"],sec:7},
];

const SECS = [{n:"The basics",d:"Quick intro"},{n:"Social energy",d:"How you are around people"},{n:"Emotional side",d:"How you connect and handle feelings"},{n:"Personality",d:"How you think and what you value"},{n:"Love style",d:"How you give and receive love"},{n:"What you want",d:"In a partner"},{n:"About you",d:"Interests and fun stuff"},{n:"Almost done",d:"Lifestyle questions"}];
const rechargeMap={"Going out with people":1,"A mix \u2014 depends on the week":2,"Quiet time, maybe one friend":3,"Completely alone":4};
const attachMap={"Embarrassingly fast":1,"Pretty quickly if the vibe is right":2,"I take my time":3,"Very slowly \u2014 I need to really know someone":4};
const goOutMap={"Every weekend":1,"Pretty often":2,"Sometimes":3,"Rarely":4};
const firstDateMap={"Coffee and a walk":"chill","Drinks at a bar":"social","Something adventurous":"adventure","Dinner somewhere nice":"classic","Cooking together at home":"intimate"};

// ALGORITHM
function orientOk(a,b) {
  const g={Male:"M",Female:"F","Non-binary":"NB"};
  const g1=g[a.answers.gender],g2=g[b.answers.gender],s1=a.answers.sexuality,s2=b.answers.sexuality;
  if(!g1||!g2||!s1||!s2) return true;
  const ok=(s,t)=>s==="Both"||s==="Not sure yet"||(s==="Men"?t==="M":s==="Women"?t==="F":true);
  return ok(s1,g2)&&ok(s2,g1);
}
function ageOk(a,b) {
  const a1=a.answers.age,a2=b.answers.age,r1=a.answers.pref_age,r2=b.answers.pref_age;
  if(!a1||!a2) return true;
  return(!r1||(a2>=r1[0]&&a2<=r1[1]))&&(!r2||(a1>=r2[0]&&a1<=r2[1]));
}
function prefMatch(sk,tg) {
  const sa=sk.answers,ta=tg.answers; let s=0,w=0;
  if(sa.pref_energy&&(ta.loud!==undefined||ta.recharge)){w+=20;const loud=ta.loud!==undefined?ta.loud:3;const rech=rechargeMap[ta.recharge]||2;if(sa.pref_energy==="Outgoing and social"){s+=(loud<=2?10:loud<=4?5:1)+(rech<=2?10:rech===3?5:1)}else if(sa.pref_energy==="Calm and thoughtful"){s+=(loud>=4?10:loud>=2?5:1)+(rech>=3?10:5)}else if(sa.pref_energy==="Ambitious and driven"){s+=(ta.freeyear==="Build something"?12:4)+(ta.saturday==="Working on something"?8:3)}else if(sa.pref_energy==="Relaxed and easy-going"){s+=(rech>=2?8:3)+(ta.saturday==="Cosy night in"||ta.saturday==="Something spontaneous"?8:3)+(loud>=3?4:1)}}
  if(sa.pref_quality){w+=15;if(sa.pref_quality==="Sense of humour"){s+=ta.conflict==="Deflect with humour"?10:4;s+=ta.humour?5:0}else if(sa.pref_quality==="Emotional intelligence"){const sec=ta.secure!==undefined?ta.secure:3;s+=(sec<=3?8:3);const att=attachMap[ta.attach]||2;s+=(att>=2&&att<=3?7:3)}else if(sa.pref_quality==="Ambition"){s+=ta.freeyear==="Build something"?15:5}else if(sa.pref_quality==="Warmth and kindness"){s+=ta.conflict==="Talk it through directly"?10:4;const sec=ta.secure!==undefined?ta.secure:3;s+=(sec<=3?5:2)}}
  if(sa.pref_energy&&ta.first_date){w+=10;const fd=firstDateMap[ta.first_date];if(sa.pref_energy==="Outgoing and social")s+=(fd==="social"||fd==="adventure")?10:4;else if(sa.pref_energy==="Calm and thoughtful")s+=(fd==="chill"||fd==="intimate")?10:4;else if(sa.pref_energy==="Ambitious and driven")s+=(fd==="classic"||fd==="chill")?10:5;else if(sa.pref_energy==="Relaxed and easy-going")s+=(fd==="chill"||fd==="intimate"||fd==="adventure")?10:4}
  return w>0?s/w:0.5;
}
function selfCompat(a,b) {
  const a1=a.answers,a2=b.answers; let s=0,w=0;
  if(a1.loud!==undefined&&a2.loud!==undefined){const d=Math.abs(a1.loud-a2.loud);s+=[8,9,7,5,3,2,1][d]||1;w+=9}
  if(a1.recharge&&a2.recharge){const d=Math.abs((rechargeMap[a1.recharge]||2)-(rechargeMap[a2.recharge]||2));s+=[9,8,5,2][d]||1;w+=9}
  if(a1.attach&&a2.attach){const d=Math.abs((attachMap[a1.attach]||2)-(attachMap[a2.attach]||2));s+=[10,8,4,1][d]||1;w+=10}
  if(a1.secure!==undefined&&a2.secure!==undefined){const d=Math.abs(a1.secure-a2.secure);s+=[8,9,7,4,2,1,0][d]||1;w+=9}
  if(a1.decide!==undefined&&a2.decide!==undefined){const d=Math.abs(a1.decide-a2.decide);s+=[7,9,8,5,3,2,1][d]||1;w+=9}
  if(a1.conflict&&a2.conflict){const good={"Talk it through directly":["Get passionate and hash it out","Deflect with humour"],"Get passionate and hash it out":["Talk it through directly","Deflect with humour"],"Need space to process first":["Deflect with humour","Talk it through directly"],"Deflect with humour":["Get passionate and hash it out","Need space to process first"]};const bad={"Need space to process first":["Get passionate and hash it out"],"Get passionate and hash it out":["Need space to process first"]};if(a1.conflict===a2.conflict)s+=7;else if(good[a1.conflict]?.includes(a2.conflict))s+=10;else if(bad[a1.conflict]?.includes(a2.conflict))s+=1;else s+=5;w+=10}
  if(a1.freeyear&&a2.freeyear){const related={"Travel everywhere":["Deepen your relationships"],"Build something":["Focus on yourself"],"Deepen your relationships":["Travel everywhere"],"Focus on yourself":["Build something"]};s+=a1.freeyear===a2.freeyear?12:related[a1.freeyear]?.includes(a2.freeyear)?8:3;w+=12}
  if(a1.humour&&a2.humour){const ok={"Dry wit and sarcasm":["Roasting and banter"],"Roasting and banter":["Dry wit and sarcasm"]};s+=a1.humour===a2.humour?12:ok[a1.humour]?.includes(a2.humour)?8:3;w+=12}
  const lM={"Words \u2014 compliments, texts, telling them":"Hearing how they feel about me","Touch \u2014 physical closeness, affection":"Physical affection","Time \u2014 giving them my full attention":"Someone giving me their undivided time","Effort \u2014 thoughtful gestures, planning, helping":"Someone going out of their way for me"};
  if(a1.love_give&&a2.love_need){s+=lM[a1.love_give]===a2.love_need?12:4;w+=12}
  if(a2.love_give&&a1.love_need){s+=lM[a2.love_give]===a1.love_need?12:4;w+=12}
  if(a1.first_date&&a2.first_date){const related={"Coffee and a walk":["Cooking together at home","Dinner somewhere nice"],"Drinks at a bar":["Something adventurous"],"Something adventurous":["Drinks at a bar"],"Dinner somewhere nice":["Coffee and a walk"],"Cooking together at home":["Coffee and a walk"]};s+=a1.first_date===a2.first_date?10:related[a1.first_date]?.includes(a2.first_date)?7:3;w+=10}
  if(a1.saturday&&a2.saturday){s+=a1.saturday===a2.saturday?8:3;w+=8}
  const h1=a1.hobbies||[],h2=a2.hobbies||[];if(h1.length&&h2.length){s+=Math.round((h1.filter(h=>h2.includes(h)).length/Math.min(h1.length,h2.length))*6);w+=6}
  if(a1.go_out&&a2.go_out){const d=Math.abs((goOutMap[a1.go_out]||2)-(goOutMap[a2.go_out]||2));s+=[10,7,3,1][d]||1;w+=10}
  ["drink","smoke"].forEach(id=>{if(a1[id]&&a2[id]){s+=a1[id]===a2[id]?8:3;w+=8}});
  return w>0?s/w:0.5;
}
function totalScore(a,b) { return Math.min(99,Math.max(20,Math.round(((prefMatch(a,b)+prefMatch(b,a))/2*0.4+selfCompat(a,b)*0.6)*100))); }
async function runMatching(excluded) { const ex=new Set(excluded||[]); const ps=(await db.profiles()).filter(p=>!ex.has(p.id)); if(ps.length<2) return []; const MAX_MATCHES=2,cands=[],count={},out=[]; for(let i=0;i<ps.length;i++) for(let j=i+1;j<ps.length;j++){if(!orientOk(ps[i],ps[j])||!ageOk(ps[i],ps[j]))continue;cands.push({i,j,sc:totalScore(ps[i],ps[j])})} cands.sort((a,b)=>b.sc-a.sc); for(const c of cands){const ci=count[c.i]||0,cj=count[c.j]||0;if(ci<MAX_MATCHES&&cj<MAX_MATCHES){count[c.i]=(ci+1);count[c.j]=(cj+1);out.push(await db.addMatch(ps[c.i].id,ps[c.j].id,c.sc))}} return out; }
// STYLES
const F = "'Nunito',sans-serif";
const T = { bg:"#FFF8F6", card:"#FFF", accent:"#FF4B6E", accentDk:"#E03A5C", accentLt:"#FFF0F3", accentMid:"#FFD0D9", rose:"#FF7B95", plum:"#9F5FCC", plumLt:"#F3E8FF", sky:"#4BABEA", skyLt:"#E6F4FD", mint:"#36B37E", mintLt:"#E3FCF0", mintDk:"#2D9D6E", amber:"#FFAA33", amberLt:"#FFF4DD", text:"#2D2D3A", textSec:"#7A7A8C", textMut:"#B8B8C8", border:"#EDE8E4" };

// COMPONENTS
function Logo({ small }) { return small ? <img src={LOGO_SM} alt="Linder" style={{ width: 80, height: 80, objectFit: "contain" }} /> : <img src={LOGO_FULL} alt="Linder" style={{ width: 200, objectFit: "contain" }} />; }
function Bar({ v, total }) { return <div style={{ height: 12, borderRadius: 6, background: T.accentLt, overflow: "hidden", marginBottom: 26 }}><div style={{ height: "100%", width: `${Math.round(((v+1)/total)*100)}%`, borderRadius: 6, background: `linear-gradient(90deg,${T.accent},${T.rose})`, boxShadow: `0 2px 0 ${T.accentDk}`, transition: "width .45s cubic-bezier(.4,.2,.2,1)" }} /></div>; }
function Confetti() { const hearts=["üíï","üíó","üíñ","‚ù§Ô∏è","üíò","üíù","ü©∑","‚ú®"]; return <div style={{ position: "fixed", inset: 0, pointerEvents: "none", zIndex: 100, overflow: "hidden" }}>{Array.from({length:30},(_,i) => <div key={i} style={{ position: "absolute", left: `${Math.random()*100}%`, top: -30, fontSize: 14+Math.random()*18, animation: `heartfall ${2+Math.random()*2}s ease-in ${Math.random()*1.5}s forwards` }}>{hearts[i%hearts.length]}</div>)}</div>; }

function Scale({ value, onChange }) {
  const items = [{s:44,c:T.mint,d:T.mintDk},{s:38,c:"#5CC99A",d:"#4BB888"},{s:32,c:"#8EDDB8",d:"#7DCCA8"},{s:26,c:"#D0D0D8",d:"#B8B8C0"},{s:32,c:"#CCA0E8",d:"#B88AD4"},{s:38,c:"#B07CE0",d:"#9A66CA"},{s:44,c:T.plum,d:"#8B4FB8"}];
  return <div>
    <div style={{ display:"flex", justifyContent:"space-between", marginBottom:14 }}><span style={{ fontFamily:F, fontSize:13, fontWeight:800, color:T.mint, textTransform:"uppercase", letterSpacing:1.2 }}>Agree</span><span style={{ fontFamily:F, fontSize:13, fontWeight:800, color:T.plum, textTransform:"uppercase", letterSpacing:1.2 }}>Disagree</span></div>
    <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>{items.map((it,i) => { const sel = value===i; return <button key={i} onClick={() => onChange(i)} style={{ width:it.s, height:it.s, borderRadius:"50%", padding:0, position:"relative", border:sel?"none":`3px solid ${it.c}`, background:sel?it.c:"transparent", cursor:"pointer", transition:"background .2s cubic-bezier(.4,.2,.2,1), transform .2s cubic-bezier(.4,.2,.2,1), box-shadow .2s cubic-bezier(.4,.2,.2,1)", transform:sel?"scale(1.12)":"scale(1)", boxShadow:sel?`0 3px 0 ${it.d},0 0 0 4px ${it.c}25`:"none" }}>{sel && <svg width={it.s*.4} height={it.s*.4} viewBox="0 0 24 24" fill="none" style={{ position:"absolute", top:"50%", left:"50%", transform:"translate(-50%,-50%)", animation:"ck .25s ease-out" }}><path d="M5 13l4 4L19 7" stroke="#fff" strokeWidth={3.5} strokeLinecap="round" strokeLinejoin="round"/></svg>}</button>; })}</div>
  </div>;
}

function Pills({ opts, value, onChange }) { return <div style={{ display:"flex", flexDirection:"column", gap:10 }}>{opts.map(o => { const s = value===o; return <button key={o} onClick={() => onChange(o)} style={{ width:"100%", padding:"15px 20px", borderRadius:14, textAlign:"left", border:`2px solid ${s?T.accent:T.border}`, background:s?T.accentLt:T.card, color:s?T.accent:T.text, fontFamily:F, fontSize:16, fontWeight:s?700:600, cursor:"pointer", boxShadow:s?`0 3px 0 ${T.accentMid}`:`0 3px 0 ${T.border}`, transition:"background .12s ease, color .12s ease, box-shadow .12s ease", outline:"none" }}>{o}</button>; })}</div>; }

function Cards({ opts, value, onChange }) { const cols = [{bg:T.accentLt,bd:T.accent,sh:T.accentMid,tx:T.accent},{bg:T.skyLt,bd:T.sky,sh:"#B8DDF4",tx:"#3A8DC8"},{bg:T.plumLt,bd:T.plum,sh:"#D8C0EE",tx:"#8050B0"},{bg:T.amberLt,bd:T.amber,sh:"#EED8A0",tx:"#B08A20"},{bg:T.mintLt,bd:T.mint,sh:"#A8E8CC",tx:T.mintDk}]; return <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:10 }}>{opts.map((o,i) => { const s = value===o; const c = cols[i%cols.length]; return <button key={o} onClick={() => onChange(o)} style={{ padding:opts.length>4?"14px 10px":"16px 12px", borderRadius:14, textAlign:"center", border:`2px solid ${s?c.bd:T.border}`, background:s?c.bg:T.card, color:s?c.tx:T.text, fontFamily:F, fontSize:13, fontWeight:700, lineHeight:1.35, cursor:"pointer", boxShadow:s?`0 3px 0 ${c.sh}`:`0 3px 0 ${T.border}`, transition:"background .12s ease, color .12s ease, transform .12s ease, box-shadow .12s ease", transform:s?"scale(1.02)":"scale(1)", outline:"none", WebkitAppearance:"none" }}>{o}</button>; })}</div>; }

function Bubbles({ opts, value, onChange, max }) { const v = value||[]; const cols = [T.accent,T.sky,T.plum,T.amber,T.mint,T.rose,"#5CC99A","#B07CE0","#FFAA33","#4BABEA"]; return <div><p style={{ fontFamily:F, fontSize:13, color:T.textSec, textAlign:"center", marginBottom:14, fontWeight:700 }}>{v.length} of {max} selected</p><div style={{ display:"flex", flexWrap:"wrap", gap:10, justifyContent:"center" }}>{opts.map((o,i) => { const s = v.includes(o); const c = cols[i%cols.length]; return <button key={o} onClick={() => { if (s) onChange(v.filter(x=>x!==o)); else if (v.length<max) onChange([...v,o]); }} style={{ padding:"10px 18px", borderRadius:22, border:`2px solid ${s?c:T.border}`, background:s?c+"15":T.card, color:s?c:T.text, fontFamily:F, fontSize:14, fontWeight:700, cursor:"pointer", boxShadow:s?`0 2px 0 ${c}40`:`0 3px 0 ${T.border}`, transition:"background .15s ease, color .15s ease, transform .15s ease, box-shadow .15s ease", transform:s?"scale(1.04)":"scale(1)" }}>{o}</button>; })}</div></div>; }

function Btn({ children, onClick, v="primary", disabled, style:ext }) { const [p,sP] = useState(false); const dn = p&&!disabled; const st = { primary:{background:T.accent,color:"#fff",boxShadow:dn?`0 1px 0 ${T.accentDk}`:`0 3px 0 ${T.accentDk}`,transform:dn?"translateY(2px)":"none"}, secondary:{background:T.card,color:T.text,border:`2px solid ${T.border}`,boxShadow:dn?"none":`0 3px 0 ${T.border}`,transform:dn?"translateY(3px)":"none"}, rose:{background:T.rose,color:"#fff",boxShadow:dn?`0 1px 0 #E06880`:`0 3px 0 #E06880`,transform:dn?"translateY(2px)":"none"}, danger:{background:T.card,color:"#E54",border:"2px solid #FCC",boxShadow:"0 2px 0 #FCC"}, ghost:{background:"transparent",color:T.textSec} }; return <button onClick={onClick} disabled={disabled} onPointerDown={() => sP(true)} onPointerUp={() => sP(false)} onPointerLeave={() => sP(false)} style={{ width:"100%", padding:"15px 24px", borderRadius:14, border:"none", fontFamily:F, fontSize:16, fontWeight:800, cursor:disabled?"not-allowed":"pointer", opacity:disabled?.4:1, transition:"all .08s ease", textAlign:"center", ...st[v], ...ext }}>{children}</button>; }

function Chip({ label, val, color=T.accent }) { return <div style={{ background:color+"10", borderRadius:12, padding:"10px 14px", border:`1.5px solid ${color}20` }}><p style={{ fontSize:10, color:T.textMut, margin:0, fontFamily:F, fontWeight:800, textTransform:"uppercase", letterSpacing:1, marginBottom:3 }}>{label}</p><p style={{ fontSize:13, color:T.text, margin:0, fontFamily:F, fontWeight:700, lineHeight:1.35 }}>{val}</p></div>; }

function MCard({ m, other, myId, onAct }) { const [show,setShow]=useState(false); const iu1=m.user1===myId, my=iu1?m.status1:m.status2, their=iu1?m.status2:m.status1; const a=other?.answers||{}; useEffect(()=>{setTimeout(()=>setShow(true),60)},[]);const traits=[]; if(a.loud!==undefined)traits.push(a.loud<=2?"Social":a.loud>=4?"Reserved":"Ambivert"); if(a.attach)traits.push(attachMap[a.attach]<=2?"Falls fast":"Takes time"); if(a.decide!==undefined)traits.push(a.decide<=2?"Heart-led":a.decide>=4?"Logic-led":"Balanced"); if(a.humour)traits.push(a.humour.split(",")[0]); const llS={"Hearing how they feel about me":"Words","Physical affection":"Touch","Someone giving me their undivided time":"Quality time","Someone going out of their way for me":"Acts of service"}; const tc=[T.accent,T.plum,T.sky,T.amber]; return <div style={{background:T.card,borderRadius:20,overflow:"hidden",marginBottom:14,border:`2px solid ${T.border}`,boxShadow:`0 4px 0 ${T.border}`,opacity:show?1:0,transform:show?"translateY(0)":"translateY(10px)",transition:"all .35s cubic-bezier(.4,.2,.2,1)"}}><div style={{background:`linear-gradient(135deg,${T.accent},${T.rose},${T.plum})`,padding:"18px 20px"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><div style={{display:"flex",alignItems:"center",gap:12}}><div style={{width:44,height:44,borderRadius:"50%",background:"rgba(255,255,255,.2)",border:"2px solid rgba(255,255,255,.3)",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:F,fontSize:20,fontWeight:800,color:"#fff"}}>?</div><div><p style={{fontFamily:F,fontSize:17,fontWeight:800,color:"#fff",margin:0}}>Blind match</p><p style={{fontFamily:F,fontSize:13,fontWeight:600,color:"rgba(255,255,255,.85)",margin:0}}>{m.score}% compatible{a.age?` ¬∑ ${a.age}`:""}</p></div></div>{my!=="pending"&&<div style={{padding:"4px 11px",borderRadius:8,background:"rgba(255,255,255,.22)",fontFamily:F,fontSize:11,fontWeight:800,color:"#fff"}}>{my==="accepted"?"Accepted":"Passed"}</div>}</div></div><div style={{padding:18}}>{traits.length>0&&<div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:14}}>{traits.map((t,i)=><span key={i} style={{padding:"5px 12px",borderRadius:10,fontSize:12,fontFamily:F,fontWeight:800,background:tc[i%tc.length]+"12",color:tc[i%tc.length],border:`1.5px solid ${tc[i%tc.length]}22`}}>{t}</span>)}</div>}<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:12}}>{a.saturday&&<Chip label="Saturday" val={a.saturday} color={T.sky}/>}{a.love_need&&<Chip label="Love language" val={llS[a.love_need]||a.love_need} color={T.rose}/>}{a.conflict&&<Chip label="In conflict" val={a.conflict} color={T.plum}/>}{a.humour&&<Chip label="Humour" val={a.humour} color={T.amber}/>}</div>{(a.hobbies||[]).length>0&&<div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:12}}>{a.hobbies.map((h,i)=><span key={i} style={{padding:"4px 10px",borderRadius:10,background:T.bg,border:`1.5px solid ${T.border}`,fontSize:12,fontFamily:F,fontWeight:700,color:T.text}}>{h}</span>)}</div>}{a.green_flag&&<div style={{background:T.mintLt,borderRadius:12,padding:"10px 14px",marginBottom:10,borderLeft:`3px solid ${T.mint}`}}><p style={{fontSize:10,color:T.mintDk,margin:0,fontFamily:F,fontWeight:800,textTransform:"uppercase",letterSpacing:1,marginBottom:3}}>Green flag</p><p style={{fontSize:13,color:T.text,margin:0,fontFamily:F,fontWeight:600,fontStyle:"italic",lineHeight:1.4}}>"{a.green_flag}"</p></div>}{a.fact&&<div style={{background:T.accentLt,borderRadius:12,padding:"10px 14px",marginBottom:14,borderLeft:`3px solid ${T.accent}`}}><p style={{fontSize:10,color:T.accent,margin:0,fontFamily:F,fontWeight:800,textTransform:"uppercase",letterSpacing:1,marginBottom:3}}>Random fact</p><p style={{fontSize:13,color:T.text,margin:0,fontFamily:F,fontWeight:600,fontStyle:"italic",lineHeight:1.4}}>"{a.fact}"</p></div>}{a.go_out&&<div style={{display:"flex",gap:8,marginBottom:12,flexWrap:"wrap"}}>{a.go_out&&<span style={{padding:"4px 10px",borderRadius:10,background:T.bg,border:`1.5px solid ${T.border}`,fontSize:12,fontFamily:F,fontWeight:700,color:T.text}}>Goes out: {a.go_out.toLowerCase()}</span>}{a.drink&&<span style={{padding:"4px 10px",borderRadius:10,background:T.bg,border:`1.5px solid ${T.border}`,fontSize:12,fontFamily:F,fontWeight:700,color:T.text}}>Drinks: {a.drink.toLowerCase()}</span>}</div>}{my==="accepted"&&their==="accepted"?<div style={{textAlign:"center",padding:20,borderRadius:16,background:`linear-gradient(135deg,${T.mintLt},${T.accentLt})`,border:`2px solid ${T.mint}40`}}><p style={{fontFamily:F,fontSize:20,fontWeight:900,margin:0,marginBottom:2,color:T.accent}}>It's a match!</p><p style={{fontFamily:F,fontSize:13,color:T.textSec,margin:0,fontWeight:600}}>The organiser will connect you both</p></div>:my==="pending"?<div style={{display:"flex",gap:10}}><Btn onClick={()=>onAct(m.id,"accepted")} style={{flex:1}}>Accept</Btn><Btn v="secondary" onClick={()=>onAct(m.id,"rejected")} style={{flex:1}}>Pass</Btn></div>:their!=="pending"?<div style={{padding:"8px 14px",borderRadius:12,textAlign:"center",background:their==="accepted"?T.mintLt:T.accentLt}}><p style={{fontFamily:F,fontSize:13,fontWeight:700,margin:0,color:their==="accepted"?T.mintDk:T.textSec}}>{their==="accepted"?"They accepted too":"They passed"}</p></div>:null}</div></div>; }

function Admin({ps,ms,onRun,onClear,onBack,onRefresh,ld,excluded,onToggleExclude}){const mut=ms.filter(m=>m.status1==="accepted"&&m.status2==="accepted").length;const activePs=ps.filter(p=>!excluded.has(p.id));return<div style={{maxWidth:460,margin:"0 auto",padding:"20px 16px"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:22}}><Logo small/><Btn v="ghost" onClick={onBack} style={{width:"auto",padding:"8px 14px",fontSize:14}}>Back</Btn></div><div style={{background:T.card,borderRadius:18,padding:20,marginBottom:14,border:`2px solid ${T.border}`,boxShadow:`0 4px 0 ${T.border}`}}><h2 style={{fontFamily:F,fontSize:20,fontWeight:800,color:T.text,margin:0}}>Admin</h2><p style={{fontFamily:F,fontSize:13,color:T.textSec,margin:"4px 0 0",fontWeight:600}}>{useSB?"Supabase connected":"Local storage mode"}</p></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10,marginBottom:14}}>{[{n:activePs.length,l:"Active",c:T.sky},{n:ms.length,l:"Pairs",c:T.accent},{n:mut,l:"Mutual",c:T.mint}].map((s,i)=><div key={i} style={{background:T.card,borderRadius:14,padding:"12px 8px",textAlign:"center",border:`2px solid ${T.border}`,boxShadow:`0 3px 0 ${T.border}`}}><p style={{fontFamily:F,fontSize:24,fontWeight:900,margin:0,color:s.c}}>{s.n}</p><p style={{fontFamily:F,fontSize:11,color:T.textMut,margin:0,fontWeight:700}}>{s.l}</p></div>)}</div>{excluded.size>0&&<p style={{fontFamily:F,fontSize:12,color:T.amber,fontWeight:700,marginBottom:10}}>{excluded.size} excluded from matching</p>}<div style={{display:"flex",gap:10,marginBottom:18}}><Btn v="rose" onClick={onRun} disabled={activePs.length<2||ld} style={{flex:2}}>{ld?"Running...":ms.length?"Re-match":"Run matching"}</Btn><Btn v="secondary" onClick={onRefresh} style={{flex:1}}>Refresh</Btn></div>{ms.map(m=>{const p1=ps.find(p=>p.id===m.user1),p2=ps.find(p=>p.id===m.user2);return<div key={m.id} style={{background:T.card,borderRadius:14,padding:14,marginBottom:8,border:`2px solid ${m.status1==="accepted"&&m.status2==="accepted"?T.mint+"50":T.border}`,boxShadow:`0 3px 0 ${T.border}`}}><p style={{fontFamily:F,fontSize:14,fontWeight:700,color:T.text,margin:0}}>{p1?.name||"?"}  {p2?.name||"?"}</p><p style={{fontFamily:F,fontSize:12,color:T.textMut,margin:"2px 0 0",fontWeight:600}}>{m.score}%  {m.status1[0]}/{m.status2[0]}</p></div>})}<p style={{fontFamily:F,fontSize:14,fontWeight:800,color:T.text,margin:"20px 0 10px"}}>Submissions ({ps.length})</p>{ps.map(p=>{const isEx=excluded.has(p.id);return<div key={p.id} style={{background:isEx?"#FFF0F0":T.card,borderRadius:12,padding:"10px 14px",marginBottom:6,border:`1.5px solid ${isEx?"#E5434440":T.border}`,display:"flex",justifyContent:"space-between",alignItems:"center",opacity:isEx?0.6:1}}><div><span style={{fontFamily:F,fontSize:14,fontWeight:700,color:T.text,textDecoration:isEx?"line-through":"none"}}>{p.name}</span><span style={{fontFamily:F,fontSize:12,color:T.textMut,fontWeight:600,marginLeft:8}}>{p.answers?.gender}  {p.answers?.age}</span></div><button onClick={()=>onToggleExclude(p.id)} style={{background:isEx?T.mint:T.accent,color:"#fff",border:"none",borderRadius:8,padding:"5px 10px",fontFamily:F,fontSize:11,fontWeight:800,cursor:"pointer"}}>{isEx?"Include":"Exclude"}</button></div>})}{ps.length>0&&<Btn v="danger" onClick={onClear} style={{marginTop:16}}>Reset all data</Btn>}</div>;}

// APP
export default function App() {
  const [scr,setScr]=useState("_");const [sess,setSR]=useState(null);const [ps,setPs]=useState([]);const [ms,setMs]=useState([]);const [qi,setQi]=useState(-1);const [pS,setPS]=useState(-1);const [name,setName]=useState("");const [ans,setAns]=useState({});const [pw,setPw]=useState("");const [pwE,setPwE]=useState(false);const [conf,setConf]=useState(false);const [ld,setLd]=useState(false);const [excluded,setExcluded]=useState(()=>{try{const e=JSON.parse(localStorage.getItem("lndr_excluded"));return new Set(e||[])}catch{return new Set()}});
  const toggleExclude=(id)=>{setExcluded(prev=>{const next=new Set(prev);if(next.has(id))next.delete(id);else next.add(id);localStorage.setItem("lndr_excluded",JSON.stringify([...next]));return next})};
  const setSess=useCallback(s=>{setSR(s);if(s)putSess(s);else delSess();},[]);
  useEffect(()=>{document.body.style.margin="0";document.body.style.background=T.bg;const s=document.createElement("style");s.textContent=`@keyframes su{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}@keyframes pi{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}@keyframes cf{0%{opacity:1;transform:translateY(0) rotate(0deg)}100%{opacity:0;transform:translateY(100vh) rotate(720deg)}}@keyframes ck{from{transform:translate(-50%,-50%) scale(0)}to{transform:translate(-50%,-50%) scale(1)}}@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}@keyframes heartfall{0%{opacity:1;transform:translateY(0) rotate(0deg) scale(1)}50%{opacity:1}100%{opacity:0;transform:translateY(100vh) rotate(360deg) scale(0.5)}}`;document.head.appendChild(s);return()=>s.remove();},[]);
  useEffect(()=>{(async()=>{const s=getSess();const p=await db.profiles();const m=await db.matches();setPs(p||[]);setMs(m||[]);if(s){setSR(s);setScr(s.adm?"admin":"match")}else setScr("home")})();},[]);
  const sA=useCallback((id,v)=>setAns(p=>({...p,[id]:v})),[]);
  const goNext=()=>{const n=qi+1;if(n>=QS.length){setQi(QS.length);return;}const cs=qi>=0?QS[qi].sec:-1,ns=QS[n].sec;if(ns!==cs&&ns>0){setPS(ns);setQi(-2)}else setQi(n)};
  const canGo=()=>{if(qi===-1)return name.trim().length>0;if(qi<0||qi>=QS.length)return true;const q=QS[qi];if(q.type==="text"||q.type==="age_range_text")return true;if(q.type==="bubble")return(ans[q.id]||[]).length>0;if(q.type==="agree")return ans[q.id]!==undefined;if(q.type==="age_text")return!!ans[q.id];return!!ans[q.id]};
  const doSubmit=async()=>{setLd(true);try{const prof=await db.addProfile(name,ans);setSess({id:prof.id,name})}catch(e){console.error(e);const f=await db.profiles();const mine=f[f.length-1];if(mine)setSess({id:mine.id,name:mine.name})}setPs(await db.profiles());setLd(false);setConf(true);setScr("done");setTimeout(()=>{setConf(false);setScr("match")},2500)};
  const act=async(mid,st)=>{const m=ms.find(m=>m.id===mid);if(!m)return;await db.updMatch(mid,m.user1===sess.id?{status1:st}:{status2:st});setMs(await db.matches())};
  const run=async()=>{setLd(true);await runMatching([...excluded]);setPs(await db.profiles());setMs(await db.matches());setLd(false)};
  const refresh=async()=>{setPs(await db.profiles());setMs(await db.matches())};
  const clear=async()=>{await db.clear();setPs([]);setMs([])};
  const logout=()=>{setSess(null);setScr("home");setQi(-1);setName("");setAns({})};
  const cq=qi>=0&&qi<QS.length?QS[qi]:null;

  if(scr==="_")return<div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:T.bg}}><Logo/></div>;
  if(scr==="home")return<div style={{minHeight:"100vh",background:T.bg,display:"flex",alignItems:"center",justifyContent:"center",padding:20}}><div style={{maxWidth:340,width:"100%",textAlign:"center",animation:"su .5s ease"}}><div style={{marginBottom:16}}><Logo/></div><p style={{fontFamily:F,fontSize:15,color:T.textSec,lineHeight:1.5,margin:"0 0 8px",fontWeight:600}}>Cupid called in sick, so we built an app instead</p><p style={{fontFamily:F,fontSize:13,color:T.textMut,margin:"0 0 36px",fontWeight:600}}>{REVEAL}</p><Btn onClick={()=>{setScr("quiz");setQi(-1)}} style={{marginBottom:10}}>Get started</Btn><Btn v="secondary" onClick={()=>setScr("pw")}>Admin</Btn></div></div>;
  if(scr==="pw")return<div style={{minHeight:"100vh",background:T.bg,display:"flex",alignItems:"center",justifyContent:"center",padding:20}}><div style={{maxWidth:320,width:"100%",textAlign:"center"}}><Logo small/><p style={{fontFamily:F,fontSize:15,fontWeight:700,color:T.textSec,margin:"22px 0 18px"}}>Enter admin password</p><input type="password" value={pw} onChange={e=>{setPw(e.target.value);setPwE(false)}} placeholder="Password" autoFocus onKeyDown={e=>{if(e.key==="Enter"){if(pw===ADMIN_PW){setSess({id:"admin",adm:true});setScr("admin")}else setPwE(true)}}} style={{width:"100%",padding:15,borderRadius:14,border:`2px solid ${pwE?"#E54":T.border}`,background:T.card,color:T.text,fontFamily:F,fontSize:17,fontWeight:700,outline:"none",textAlign:"center",boxShadow:`0 3px 0 ${T.border}`}}/>{pwE&&<p style={{fontFamily:F,fontSize:13,color:"#E54",fontWeight:700,margin:"8px 0 0"}}>Wrong password</p>}<Btn onClick={()=>{if(pw===ADMIN_PW){setSess({id:"admin",adm:true});setScr("admin")}else setPwE(true)}} style={{marginTop:14,marginBottom:10}}>Enter</Btn><Btn v="ghost" onClick={()=>{setScr("home");setPw("")}}>Back</Btn></div></div>;

  if(scr==="quiz")return<div style={{minHeight:"100vh",background:T.bg,padding:"20px 16px 60px",overflow:"hidden"}}><div style={{maxWidth:420,margin:"0 auto"}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}><Logo small/>{qi>=0&&qi<QS.length&&<span style={{fontFamily:F,fontSize:13,color:T.textMut,fontWeight:800}}>{qi+1}/{QS.length}</span>}</div>
    {qi>=0&&qi<QS.length&&<Bar v={qi} total={QS.length}/>}
    {qi===-2&&<div key="sec" style={{textAlign:"center",paddingTop:44,animation:"su .4s ease",overflow:"hidden"}}><div style={{width:60,height:60,borderRadius:16,margin:"0 auto 16px",background:T.card,border:`2px solid ${T.border}`,boxShadow:`0 4px 0 ${T.border}`,display:"flex",alignItems:"center",justifyContent:"center",animation:"pi .4s ease"}}><span style={{fontFamily:F,fontSize:24,fontWeight:900,color:T.accent}}>{pS+1}</span></div><h2 style={{fontFamily:F,fontSize:22,fontWeight:900,color:T.text,margin:0}}>{SECS[pS]?.n}</h2><p style={{fontFamily:F,fontSize:14,color:T.textSec,fontWeight:600,margin:"6px 0 32px"}}>{SECS[pS]?.d}</p><Btn onClick={()=>setQi(QS.findIndex(q=>q.sec===pS))}>Continue</Btn></div>}
    {qi===-1&&<div style={{paddingTop:20,animation:"su .4s ease"}}><h2 style={{fontFamily:F,fontSize:24,fontWeight:900,color:T.text,margin:"0 0 6px"}}>What's your name?</h2><p style={{fontFamily:F,fontSize:14,color:T.textSec,marginBottom:26,fontWeight:600}}>Only the organiser will see this</p><input type="text" value={name} onChange={e=>setName(e.target.value)} placeholder="Your name" maxLength={50} autoFocus onKeyDown={e=>{if(e.key==="Enter"&&canGo())goNext()}} style={{width:"100%",padding:15,borderRadius:14,border:`2px solid ${name?T.accent:T.border}`,background:T.card,color:T.text,fontFamily:F,fontSize:18,fontWeight:700,outline:"none",textAlign:"center",boxShadow:`0 3px 0 ${T.border}`,transition:"border .2s"}}/><div style={{marginTop:18}}><Btn onClick={goNext} disabled={!canGo()}>Continue</Btn></div></div>}
    {cq&&<div key={qi} style={{animation:"su .3s ease"}}><p style={{fontFamily:F,fontSize:12,fontWeight:800,color:T.accent,textTransform:"uppercase",letterSpacing:1.5,marginBottom:6}}>{SECS[cq.sec]?.n}</p><h2 style={{fontFamily:F,fontSize:21,fontWeight:800,color:T.text,margin:"0 0 22px",lineHeight:1.4}}>{cq.q}</h2>
      {cq.type==="agree"&&<div style={{marginBottom:28}}><Scale value={ans[cq.id]} onChange={v=>sA(cq.id,v)}/></div>}
      {cq.type==="pill"&&<div style={{marginBottom:24}}><Pills opts={cq.opts} value={ans[cq.id]} onChange={v=>sA(cq.id,v)}/></div>}
      {cq.type==="card"&&<div style={{marginBottom:24}}><Cards opts={cq.opts} value={ans[cq.id]} onChange={v=>sA(cq.id,v)}/></div>}
      {cq.type==="bubble"&&<div style={{marginBottom:24}}><Bubbles opts={cq.opts} value={ans[cq.id]} onChange={v=>sA(cq.id,v)} max={cq.max}/></div>}
      {cq.type==="age_text"&&<div style={{marginBottom:24}}><input inputMode="numeric" pattern="[0-9]*" value={ans[cq.id]||""} placeholder="‚Äî" onChange={e=>{const v=e.target.value.replace(/\D/g,"");const n=parseInt(v);if(v==="")sA(cq.id,undefined);else if(n>=16&&n<=30)sA(cq.id,n);else if(v.length<=2)sA(cq.id,v)}} style={{width:"100%",padding:18,borderRadius:14,border:`2px solid ${ans[cq.id]?T.accent:T.border}`,background:T.card,color:T.text,fontFamily:F,fontSize:32,fontWeight:900,textAlign:"center",outline:"none",boxShadow:`0 3px 0 ${T.border}`}}/></div>}
      {cq.type==="age_range_text"&&<div style={{marginBottom:24,display:"flex",gap:14,alignItems:"center"}}><div style={{flex:1}}><p style={{fontFamily:F,fontSize:12,fontWeight:800,color:T.textMut,textAlign:"center",marginBottom:6,textTransform:"uppercase",letterSpacing:1}}>From</p><input inputMode="numeric" value={(ans[cq.id]||[17,22])[0]} onChange={e=>{const n=parseInt(e.target.value)||16;const c=ans[cq.id]||[17,22];sA(cq.id,[Math.max(16,Math.min(n,c[1])),c[1]])}} style={{width:"100%",padding:14,borderRadius:14,border:`2px solid ${T.border}`,background:T.card,color:T.text,fontFamily:F,fontSize:24,fontWeight:900,textAlign:"center",outline:"none",boxShadow:`0 3px 0 ${T.border}`}}/></div><span style={{fontFamily:F,fontSize:16,color:T.textMut,fontWeight:800,marginTop:18}}>to</span><div style={{flex:1}}><p style={{fontFamily:F,fontSize:12,fontWeight:800,color:T.textMut,textAlign:"center",marginBottom:6,textTransform:"uppercase",letterSpacing:1}}>To</p><input inputMode="numeric" value={(ans[cq.id]||[17,22])[1]} onChange={e=>{const n=parseInt(e.target.value)||30;const c=ans[cq.id]||[17,22];sA(cq.id,[c[0],Math.min(30,Math.max(n,c[0]))])}} style={{width:"100%",padding:14,borderRadius:14,border:`2px solid ${T.border}`,background:T.card,color:T.text,fontFamily:F,fontSize:24,fontWeight:900,textAlign:"center",outline:"none",boxShadow:`0 3px 0 ${T.border}`}}/></div></div>}
      {cq.type==="text"&&<div style={{marginBottom:24}}><textarea value={ans[cq.id]||""} onChange={e=>sA(cq.id,e.target.value)} placeholder={cq.ph} maxLength={200} style={{width:"100%",minHeight:100,padding:15,borderRadius:14,border:`2px solid ${ans[cq.id]?T.accent:T.border}`,background:T.card,color:T.text,fontFamily:F,fontSize:16,fontWeight:600,resize:"vertical",outline:"none",lineHeight:1.5,boxShadow:`0 3px 0 ${T.border}`,transition:"border .2s"}}/><p style={{textAlign:"right",fontSize:12,color:T.textMut,margin:"4px 0 0",fontFamily:F,fontWeight:700}}>{(ans[cq.id]||"").length}/200</p></div>}
      <div style={{display:"flex",gap:10}}><Btn v="secondary" onClick={()=>setQi(qi===0?-1:qi-1)} style={{flex:1}}>Back</Btn><Btn onClick={goNext} disabled={!canGo()} style={{flex:2}}>{qi===QS.length-1?"Review":"Continue"}</Btn></div>
    </div>}
    {qi===QS.length&&<div style={{paddingTop:8,animation:"su .4s ease"}}><div style={{background:T.card,borderRadius:18,padding:"20px 18px",marginBottom:16,border:`2px solid ${T.border}`,boxShadow:`0 4px 0 ${T.border}`,textAlign:"center"}}><div style={{width:52,height:52,borderRadius:"50%",margin:"0 auto 10px",background:T.accentLt,display:"flex",alignItems:"center",justifyContent:"center"}}><svg width={24} height={24} viewBox="0 0 24 24" fill="none"><path d="M9 12l2 2 4-4" stroke={T.accent} strokeWidth={2.5} strokeLinecap="round" strokeLinejoin="round"/><circle cx={12} cy={12} r={9} stroke={T.accent} strokeWidth={2}/></svg></div><h2 style={{fontFamily:F,fontSize:20,fontWeight:900,color:T.text,margin:"0 0 4px"}}>Ready to submit?</h2><p style={{fontFamily:F,fontSize:13,color:T.textSec,fontWeight:600,margin:0}}>Check your answers below</p></div><div style={{background:T.card,borderRadius:18,overflow:"hidden",marginBottom:16,border:`2px solid ${T.border}`,boxShadow:`0 4px 0 ${T.border}`}}><div style={{padding:"16px 18px",borderBottom:`2px solid ${T.border}`}}><p style={{fontFamily:F,fontSize:18,fontWeight:800,color:T.text,margin:0}}>{name}</p><p style={{fontFamily:F,fontSize:13,fontWeight:600,color:T.textSec,margin:"2px 0 0"}}>{ans.gender} ¬∑ {ans.age}</p></div><div style={{padding:"14px 18px"}}><p style={{fontFamily:F,fontSize:11,fontWeight:800,color:T.textMut,textTransform:"uppercase",letterSpacing:1,margin:"0 0 8px"}}>Personality</p><div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:16}}>{[ans.loud!==undefined&&(ans.loud<=2?"Social":ans.loud>=4?"Reserved":"Ambivert"),ans.attach&&(attachMap[ans.attach]<=2?"Falls fast":"Takes time"),ans.decide!==undefined&&(ans.decide<=2?"Heart-led":ans.decide>=4?"Logic-led":"Balanced"),ans.humour].filter(Boolean).map((t,i)=><span key={i} style={{padding:"5px 12px",borderRadius:10,fontSize:12,fontFamily:F,fontWeight:800,background:T.bg,color:T.text,border:`1.5px solid ${T.border}`}}>{t}</span>)}</div>{ans.green_flag&&<><p style={{fontFamily:F,fontSize:11,fontWeight:800,color:T.textMut,textTransform:"uppercase",letterSpacing:1,margin:"0 0 6px"}}>Green flag</p><div style={{background:T.bg,borderRadius:12,padding:"10px 14px",marginBottom:16,border:`1.5px solid ${T.border}`}}><p style={{fontSize:13,color:T.text,margin:0,fontFamily:F,fontWeight:600,fontStyle:"italic",lineHeight:1.4}}>"{ans.green_flag}"</p></div></>}<p style={{fontFamily:F,fontSize:11,fontWeight:800,color:T.textMut,textTransform:"uppercase",letterSpacing:1,margin:"0 0 8px"}}>Love style</p><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:16}}>{ans.love_give&&<Chip label="Shows love" val={ans.love_give.split(" \u2014 ")[0]} color={T.textMut}/>}{ans.love_need&&<Chip label="Needs" val={ans.love_need} color={T.textMut}/>}</div><p style={{fontFamily:F,fontSize:11,fontWeight:800,color:T.textMut,textTransform:"uppercase",letterSpacing:1,margin:"0 0 8px"}}>Looking for</p><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:16}}>{ans.pref_energy&&<Chip label="Drawn to" val={ans.pref_energy} color={T.textMut}/>}{ans.pref_quality&&<Chip label="Top quality" val={ans.pref_quality} color={T.textMut}/>}{ans.first_date&&<Chip label="First date" val={ans.first_date} color={T.textMut}/>}</div>{(ans.hobbies||[]).length>0&&<><p style={{fontFamily:F,fontSize:11,fontWeight:800,color:T.textMut,textTransform:"uppercase",letterSpacing:1,margin:"0 0 8px"}}>Hobbies</p><div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:16}}>{ans.hobbies.map((h,i)=><span key={i} style={{padding:"4px 10px",borderRadius:10,background:T.bg,border:`1.5px solid ${T.border}`,fontSize:12,fontFamily:F,fontWeight:700,color:T.text}}>{h}</span>)}</div></>}{ans.fact&&<><p style={{fontFamily:F,fontSize:11,fontWeight:800,color:T.textMut,textTransform:"uppercase",letterSpacing:1,margin:"0 0 6px"}}>Random fact</p><div style={{background:T.bg,borderRadius:12,padding:"10px 14px",marginBottom:16,border:`1.5px solid ${T.border}`}}><p style={{fontSize:13,color:T.text,margin:0,fontFamily:F,fontWeight:600,fontStyle:"italic",lineHeight:1.4}}>"{ans.fact}"</p></div></>}<p style={{fontFamily:F,fontSize:11,fontWeight:800,color:T.textMut,textTransform:"uppercase",letterSpacing:1,margin:"0 0 8px"}}>Lifestyle</p><div style={{display:"flex",flexWrap:"wrap",gap:6}}>{[ans.go_out&&`Goes out: ${ans.go_out.toLowerCase()}`,ans.drink&&`Drinks: ${ans.drink.toLowerCase()}`,ans.smoke&&`Smokes: ${ans.smoke.toLowerCase()}`].filter(Boolean).map((t,i)=><span key={i} style={{padding:"4px 10px",borderRadius:10,background:T.bg,border:`1.5px solid ${T.border}`,fontSize:12,fontFamily:F,fontWeight:700,color:T.text}}>{t}</span>)}</div></div></div><div style={{display:"flex",gap:10}}><Btn v="secondary" onClick={()=>setQi(QS.length-1)} style={{flex:1}}>Back</Btn><Btn v="rose" onClick={doSubmit} disabled={ld} style={{flex:2}}>{ld?"Submitting...":"Submit"}</Btn></div></div>}
  </div></div>;

  if(scr==="done")return<div style={{minHeight:"100vh",background:T.bg,display:"flex",alignItems:"center",justifyContent:"center",padding:20}}>{conf&&<Confetti/>}<div style={{textAlign:"center",animation:"pi .5s ease",position:"relative",zIndex:1}}><div style={{width:68,height:68,borderRadius:"50%",margin:"0 auto 18px",background:T.mintLt,border:`3px solid ${T.mint}`,display:"flex",alignItems:"center",justifyContent:"center"}}><svg width={30} height={30} viewBox="0 0 24 24" fill="none"><path d="M5 13l4 4L19 7" stroke={T.mint} strokeWidth={3.5} strokeLinecap="round" strokeLinejoin="round"/></svg></div><h2 style={{fontFamily:F,fontSize:24,fontWeight:900,color:T.text,margin:"0 0 6px"}}>You're in!</h2><p style={{fontFamily:F,fontSize:14,color:T.textSec,fontWeight:600}}>{REVEAL}</p></div></div>;

  if(scr==="match"){const my=ms.filter(m=>m.user1===sess?.id||m.user2===sess?.id);return<div style={{minHeight:"100vh",background:T.bg,padding:"20px 16px"}}><div style={{maxWidth:420,margin:"0 auto"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:18}}><Logo small/><div style={{display:"flex",gap:6}}><button onClick={refresh} style={{background:T.card,border:`2px solid ${T.border}`,color:T.textSec,padding:"7px 14px",borderRadius:12,fontFamily:F,fontSize:13,fontWeight:700,cursor:"pointer",boxShadow:`0 3px 0 ${T.border}`}}>Refresh</button><button onClick={logout} style={{background:"none",border:"none",color:T.textMut,fontFamily:F,fontSize:13,fontWeight:700,cursor:"pointer"}}>Logout</button></div></div><div style={{background:T.card,borderRadius:18,padding:20,marginBottom:16,border:`2px solid ${T.border}`,boxShadow:`0 4px 0 ${T.border}`}}><h2 style={{fontFamily:F,fontSize:22,fontWeight:900,color:T.text,margin:0,marginBottom:2}}>Your matches</h2><p style={{fontFamily:F,fontSize:14,color:T.textSec,margin:0,fontWeight:600}}>Hey, {sess?.name?.split(" ")[0]}</p></div>{my.length===0?<div style={{textAlign:"center",padding:"44px 20px",background:T.card,borderRadius:18,border:`2px solid ${T.border}`,boxShadow:`0 4px 0 ${T.border}`}}><img src={LOGO_MD} alt="" style={{width:120,height:120,objectFit:"contain",marginBottom:14}}/><p style={{fontFamily:F,fontSize:18,fontWeight:800,color:T.text,margin:"0 0 6px"}}>No matches yet</p><p style={{fontFamily:F,fontSize:14,color:T.textSec,fontWeight:600,margin:0}}>{REVEAL}</p></div>:my.map(m=><MCard key={m.id} m={m} other={ps.find(p=>p.id===(m.user1===sess.id?m.user2:m.user1))} myId={sess.id} onAct={act}/>)}</div></div>;}

  if(scr==="admin")return<Admin ps={ps} ms={ms} onRun={run} onClear={clear} onBack={logout} onRefresh={refresh} ld={ld} excluded={excluded} onToggleExclude={toggleExclude}/>;
  return null;
}
